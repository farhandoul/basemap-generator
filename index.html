<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Basemap Generator — RealScale Crop</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{--bg:#000;--card:#111;--accent:#0f0;--muted:#0c0;--radius:12px;--glass:#111c}
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;color:#cfc;background:#000}
  .app{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns:1fr 360px;gap:16px}
  .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 0 18px rgba(0,255,0,0.6)}
  header{grid-column:1/-1;display:flex;gap:12px;align-items:center;padding:12px;border-bottom:1px solid #0f03}
  h1{margin:0;font-size:20px;font-weight:800;color:#0f0}
  #map-wrap{position:relative;height:72vh;border-radius:10px;overflow:hidden;box-shadow:0 0 22px rgba(0,255,0,0.4)}
  #map{height:100%;width:100%}
  #searchBarWrap{position:absolute;left:14px;top:14px;z-index:2000;display:flex;gap:8px;width:290px;background:#000;padding:8px;border-radius:10px;box-shadow:0 4px 16px rgba(0,255,0,0.6)}
  #searchInput{flex:1;padding:10px;border-radius:8px;border:1px solid #0f05;background:#000;color:#0f0;font-weight:600}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid #0f07;background:#000;color:#0f0;font-weight:700;cursor:pointer;box-shadow:0 0 10px rgba(0,255,0,0.5)}
  .btn:active{transform:scale(0.96)}
  #cropBox{position:absolute;border:3px solid #0f0;cursor:move;z-index:1900;display:flex;align-items:center;justify-content:center;color:#0f0;font-weight:800;background:rgba(0,255,0,0.06);border-radius:8px;box-shadow:0 0 16px rgba(0,255,0,0.6)}
  .handle{position:absolute;width:12px;height:12px;background:#0f0;border-radius:3px}
  .h-tl{left:-6px;top:-6px;cursor:nwse-resize}.h-tr{right:-6px;top:-6px;cursor:nesw-resize}
  .h-bl{left:-6px;bottom:-6px;cursor:nesw-resize}.h-br{right:-6px;bottom:-6px;cursor:nwse-resize}
  aside{display:flex;flex-direction:column;gap:10px}
  select,input,textarea{padding:10px;border-radius:8px;border:1px solid #0f05;background:#000;color:inherit}
  textarea{resize:vertical;min-height:60px}
  pre#result{background:#001000;padding:10px;border-radius:8px;overflow:auto;color:#0f0;font-size:13px;min-height:150px}
</style>
</head>
<body>
  <div class="app">
    <header class="card">
      <h1 style="font-weight:900;font-size:22px;text-shadow:0 0 14px #0f0">
        BASEMAP-GENERATOR <b>powered by ChatGPT & NXTIndustries</b>
      </h1>
    </header>

    <div class="card" id="map-wrap">
      <div id="searchBarWrap">
        <input id="searchInput" type="text" placeholder="Search place or address"/>
        <button id="btnSearch" class="btn ghost">Search</button>
      </div>

      <div id="map"></div>

      <div id="cropBox">
        <div style="pointer-events:none">Crop</div>
        <div class="handle h-tl" data-h="h-tl"></div>
        <div class="handle h-tr" data-h="h-tr"></div>
        <div class="handle h-bl" data-h="h-bl"></div>
        <div class="handle h-br" data-h="h-br"></div>
      </div>
    </div>

    <aside class="card">
      <label class="small">Output Size</label>
      <select id="sizeSel"><option value="1024">1024 × 1024</option><option value="2048">2048 × 2048</option><option value="4096">4096 × 4096</option></select>

      <label class="small">KUID (config.txt)</label>
      <input id="kuidInput" type="text" placeholder="ex: 123456:7890"/>

      <label class="small">Trainz Build</label>
      <input id="buildInput" type="text" placeholder="ex: 5.1"/>

      <label class="small">Author</label>
      <input id="authorInput" type="text" placeholder="ex: Farhan"/>

      <label class="small">Publisher</label>
      <input id="pubInput" type="text" placeholder="ex: NXTIndustries"/>

      <label class="small">Description</label>
      <textarea id="descInput" placeholder="Describe your basemap asset..."></textarea>

      <label class="small">Map Real Size (meters, square)</label>
      <input id="metersInput" type="number" value="720"/>
      <button id="setMetersBtn" class="btn ghost">Set crop size (m)</button>

      <div style="display:flex;gap:8px">
        <button id="btnGenerate" class="btn">Generate</button>
        <button id="btnExport" class="btn ghost" disabled>Export ZIP</button>
      </div>

      <pre id="result">Ready.</pre>
    </aside>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
// init map (zoom locked real scale)
const map = L.map('map', {
  center: [-7.0, 110.4],
  zoom: 17,
  zoomControl: false,
  scrollWheelZoom: false,
  doubleClickZoom: false,
  boxZoom: false,
  touchZoom: false,
  keyboard: false,
  dragging: true
});
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const crop = document.getElementById('cropBox');
const mapContainer = map.getContainer();
let lastImageBlob=null; let lastSize=1024;

// keep 1:1 square
function enforceSquare(w,h){
  return Math.min(w,h);
}
function resetCrop(){
  const m = document.getElementById('metersInput').value || 720;
  const px = m / metersPerPixel(map.getCenter().lat, map.getZoom());
  const sizePx = Math.min(px, mapContainer.clientWidth - 10, mapContainer.clientHeight - 10);
  const s = enforceSquare(sizePx,sizePx);
  crop.style.width=s+'px'; crop.style.height=s+'px';
  crop.style.left=(mapContainer.clientWidth/2 - s/2)+'px'; crop.style.top=(mapContainer.clientHeight/2 - s/2)+'px';
}
resetCrop(); window.addEventListener('resize',resetCrop);

// mpp formula
function metersPerPixel(lat,zoom){
  return 156543.03392 * Math.cos(lat*Math.PI/180)/Math.pow(2,zoom);
}
function getCropBbox(){
  const r=crop.getBoundingClientRect(), mr=mapContainer.getBoundingClientRect();
  const x1=r.left-mr.left,y1=r.top-mr.top,x2=x1+r.width,y2=y1+r.height;
  const a=map.containerPointToLatLng([x1,y1]),b=map.containerPointToLatLng([x2,y2]);
  return [Math.min(a.lng,b.lng),Math.min(a.lat,b.lat),Math.max(a.lng,b.lng),Math.max(a.lat,b.lat)];
}
map.on('move',resetCrop);

// search
document.getElementById('btnSearch').addEventListener('click',async()=>{
  const q=document.getElementById('searchInput').value.trim(); if(!q) return;
  const url='https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q);
  try{const d=await (await fetch(url)).json(); if(!d.length) return alert('Not found'); map.setView([+d[0].lat,+d[0].lon],map.getZoom()); }catch(e){alert('Search error');}
});

// generate from Esri (Square real scale locked)
document.getElementById('btnGenerate').addEventListener('click', async()=>{
  const size=parseInt(sizeSel.value,10);
  const bbox=getCropBbox();
  document.getElementById('status');
  document.getElementById('result').innerText='Fetching image...';
  try{
    const params=new URLSearchParams({bbox:bbox.join(','),bboxSR:4326,size:`${size},${size}`,imageSR:3857,format:'jpgpng',f:'image'});
    const res=await fetch('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/export?'+params);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const blob=await res.blob(); lastImageBlob=blob; lastSize=size;
    document.getElementById('result').innerText=`Image OK: ${size}×${size} (${metersInput.value}m approx at center)`;
    btnExport.disabled=false;
  }catch(e){result.innerText='Error: '+e}
});

// export zip with custom config & texture
document.getElementById('btnExport').addEventListener('click',async()=>{
  if(!lastImageBlob) return alert('Generate first');
  result.innerText='Building ZIP...';
  const preview=await createImageBitmap(lastImageBlob);
  const c=document.createElement('canvas'); c.width=240;c.height=180;c.getContext('2d').drawImage(preview,0,0,240,180);
  const thumbBlob=await new Promise(r=>c.toBlob(r,'image/jpeg'));

  const textureTxt = "Primary=basemap.png\nTile=st\n";

  const configTxt = `kuid <kuid:${kuidInput.value}>\nusername "Basemap Asset"\nkind scenery\ntrainz-build ${buildInput.value}\nauthor "${authorInput.value}"\npublisher "${pubInput.value}"\ndescription "${descInput.value}"`;

  const zip=new JSZip();
  zip.file('basemap.png',lastImageBlob);
  zip.file('thumbnail.jpg',thumbBlob);
  zip.file('basemap.texture.txt',textureTxt);
  zip.file('config.txt',configTxt);
  zip.file('basemap.im','imfileversion 1.0');
  saveAs(await zip.generateAsync({type:'blob'}),'trainz_basemap.zip');
  result.innerText='ZIP saved!';
});
</script>
</body>
</html>

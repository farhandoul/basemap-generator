<!-- Basemap Generator - Improved UI with Adjustable Crop Box -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basemap Generator HD+</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; font-family:Arial, sans-serif; background:#111; color:white; }
    #map { width:100vw; height:75vh; position:relative; }
    #panel { padding:12px; background:#222; display:flex; gap:10px; align-items:center; }
    button { padding:10px 15px; border-radius:8px; border:0; background:#4caf50; color:white; cursor:pointer; font-weight:bold }
    button:disabled { opacity:0.5; }
    #searchBox { position:absolute; top:15px; left:15px; z-index:1000; display:flex; gap:6px; }
    #searchInput { padding:8px; width:260px; border-radius:6px; border:1px solid #666; }
    #cropBox { position:absolute; border:3px dashed #00eaff; z-index:900; pointer-events:none; }
    #result { padding:10px; background:#000; max-height:15vh; overflow:auto; border-radius:6px; }
  </style>
</head>
<body>

  <!-- Search UI -->
  <div id="searchBox">
    <input id="searchInput" type="text" placeholder="Search location..." />
    <button id="btnSearch" style="background:#2196F3">Search</button>
  </div>

  <div id="map">
    <div id="cropBox"></div>
  </div>

  <div id="panel">
    <label>Size:</label>
    <select id="sizeSel">
      <option value="1024">1024 × 1024</option>
      <option value="2048">2048 × 2048</option>
      <option value="4096">4096 × 4096</option>
    </select>

    <button id="btnGenerate">Generate</button>
    <button id="btnExport" disabled>Export ZIP</button>
    <span id="status"></span>
  </div>

  <pre id="result">Ready.</pre>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    const map = L.map('map', { center:[-7.0,110.4], zoom:16 });

    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_satellite/{z}/{x}/{y}.jpg', {
      maxZoom:20,
      attribution:'© Stadia Maps'
    }).addTo(map);

    let lastImageBlob = null;
    let lastSize = 1024;

    const cropBox = document.getElementById('cropBox');
    const mapDiv = document.getElementById('map');

    function updateCrop(){
      const w = mapDiv.clientWidth * 0.35;
      const h = mapDiv.clientHeight * 0.35;
      cropBox.style.width = w + 'px';
      cropBox.style.height = h + 'px';
      cropBox.style.left = (mapDiv.clientWidth/2 - w/2) + 'px';
      cropBox.style.top = (mapDiv.clientHeight/2 - h/2) + 'px';
    }
    updateCrop();
    window.addEventListener('resize', updateCrop);

    document.getElementById("btnSearch").addEventListener("click", async () => {
      const q = document.getElementById("searchInput").value.trim();
      if (!q) return;
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.length) return alert("Not found!");
        map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 17);
      } catch(e){ alert("Search error"); }
    });

    function getCropBounds(){
      const rect = cropBox.getBoundingClientRect();
      const mapRect = mapDiv.getBoundingClientRect();
      const x1 = rect.left - mapRect.left;
      const y1 = rect.top - mapRect.top;
      const x2 = x1 + rect.width;
      const y2 = y1 + rect.height;
      const p1 = map.containerPointToLatLng([x1, y1]);
      const p2 = map.containerPointToLatLng([x2, y2]);
      return [p2.lng, p2.lat, p1.lng, p1.lat];
    }

    function buildUrl(bbox, size){
      const p = new URLSearchParams({ bbox:bbox.join(','), bboxSR:4326, size:`${size},${size}`, f:'image', format:'jpgpng' });
      return `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/export?${p}`;
    }

    document.getElementById('btnGenerate').addEventListener('click', async () => {
      const size = parseInt(document.getElementById('sizeSel').value, 10);
      lastSize = size;
      const bbox = getCropBounds();
      const url = buildUrl(bbox, size);
      document.getElementById('status').innerText = 'Fetching...';
      try{
        const res = await fetch(url);
        lastImageBlob = await res.blob();
        document.getElementById('btnExport').disabled = false;
        document.getElementById('status').innerText = 'Ready';
      }catch(e){ document.getElementById('status').innerText = 'Error'; }
    });

    document.getElementById('btnExport').addEventListener('click', async () => {
      const zip = new JSZip();
      const imgBitmap = await createImageBitmap(lastImageBlob);
      const thumb = document.createElement('canvas'); thumb.width=240; thumb.height=180;
      thumb.getContext('2d').drawImage(imgBitmap,0,0,240,180);
      const thumbBlob = await new Promise(r=>thumb.toBlob(r,'image/jpeg'));

      zip.file('basemap.jpg', lastImageBlob);
      zip.file('thumbnail.jpg', thumbBlob);

      zip.file('basemap.texture.txt', 'basemap.jpg\ncompression=jpeg\n');

      zip.file('config.txt', `kuid <kuid:xxxxxx:xxxx>\nusername "Basemap HD"\nkind "scenery"\nmesh-table { default { mesh "basemap.im" auto-create 1 } }`);

      zip.file('basemap.im', `imfileversion 1.0`);

      saveAs(await zip.generateAsync({type:'blob'}), 'trainz_basemap.zip');
      document.getElementById('status').innerText = 'ZIP Ready';
    });
  </script>
</body>
</html>

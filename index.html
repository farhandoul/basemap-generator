<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Basemap Generator — RealScale Crop</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{--bg:#0f1113;--card:#111316aa;--accent:#60a5fa;--muted:#9aa4b2;--radius:12px}
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;color:#e6eef8;background:linear-gradient(180deg,#0b0f14,#0f1113)}
  .app{max-width:1200px;margin:20px auto;padding:14px;display:grid;grid-template-columns:1fr 360px;gap:16px}
  .card{background:var(--card);backdrop-filter:blur(8px);border-radius:var(--radius);padding:12px;box-shadow:0 8px 30px rgba(2,6,23,0.45);border:1px solid rgba(255,255,255,0.03)}
  header{grid-column:1/-1;display:flex;gap:12px;align-items:center;padding:8px 12px;margin-bottom:6px}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7dd3fc);display:flex;align-items:center;justify-content:center;font-weight:700;color:#043a5b}
  h1{font-size:16px;margin:0}
  #map-wrap{position:relative;height:72vh;border-radius:10px;overflow:hidden}
  #map{height:100%;width:100%}
  .top-controls{position:absolute;left:12px;top:12px;z-index:1200;display:flex;gap:8px;align-items:center}
  .top-controls input[type=text], .top-controls input[type=number]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:inherit}
  .btn{padding:8px 12px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent),#3b82f6);color:#04243a;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
  #cropBox{position:absolute;border:3px solid rgba(96,165,250,0.95);box-shadow:0 6px 20px rgba(2,6,23,0.55);border-radius:8px;cursor:move;z-index:1100;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700;user-select:none}
  .handle{position:absolute;width:12px;height:12px;background:var(--accent);border-radius:3px;z-index:1110}
  .h-tl{left:-6px;top:-6px;cursor:nwse-resize}.h-tr{right:-6px;top:-6px;cursor:nesw-resize}
  .h-bl{left:-6px;bottom:-6px;cursor:nesw-resize}.h-br{right:-6px;bottom:-6px;cursor:nwse-resize}
  .meta{display:flex;flex-direction:column;gap:10px}
  label.small{font-size:12px;color:var(--muted)}
  pre#result{background:#061018;padding:10px;border-radius:8px;overflow:auto;color:#cfeefe;min-height:140px}
  @media(max-width:980px){.app{grid-template-columns:1fr;padding:10px}}
</style>
</head>
<body>
  <div class="app">
    <header class="card">
      <div class="logo">BG</div>
      <div>
        <h1>Basemap Generator — RealScale</h1>
        <div style="font-size:12px;color:var(--muted)">Fixed-scale crop (1:1 real world) — pan allowed, zoom disabled</div>
      </div>
    </header>

    <div class="card" id="map-wrap">
      <div class="top-controls">
        <input id="searchInput" type="text" placeholder="Search place or address"/>
        <button id="btnSearch" class="btn btn-ghost">Search</button>

        <input id="metersInput" type="number" placeholder="meters" style="width:110px" value="720"/>
        <button id="setMetersBtn" class="btn">Set Crop Size (m)</button>

        <label style="display:flex;align-items:center;gap:6px;color:var(--muted);margin-left:6px">
          <input id="lockZoom" type="checkbox" checked/> Lock Zoom
        </label>
      </div>

      <div id="map"></div>

      <div id="cropBox">
        <div style="pointer-events:none">Crop</div>
        <div class="handle h-tl" data-h="h-tl"></div>
        <div class="handle h-tr" data-h="h-tr"></div>
        <div class="handle h-bl" data-h="h-bl"></div>
        <div class="handle h-br" data-h="h-br"></div>
      </div>
    </div>

    <aside class="card meta">
      <div>
        <label class="small">Output Size</label>
        <select id="sizeSel"><option value="1024">1024 × 1024</option><option value="2048">2048 × 2048</option><option value="4096">4096 × 4096</option></select>
      </div>

      <div>
        <label class="small">Actions</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="btnGenerate" class="btn">Generate</button>
          <button id="btnExport" class="btn ghost" disabled>Export ZIP</button>
        </div>
      </div>

      <div class="card">
        <label class="small">Preview / Logs</label>
        <pre id="result">Ready. Crop meters will show here.</pre>
      </div>
    </aside>

  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
/*
 Features:
 - Lock zoom (disable wheel/dbl-click/boxzoom/touch)
 - Pan allowed
 - Set crop to exact meters at center latitude/zoom
 - Show current crop meter size (updates when crop moved/resized)
 - Export uses Esri export API (HD)
*/

// init map
const map = L.map('map', {
  center: [-7.0, 110.4],
  zoom: 15,
  zoomControl: false,      // hide +/-
  scrollWheelZoom: false,
  doubleClickZoom: false,
  boxZoom: false,
  touchZoom: false,
  keyboard: false,
  dragging: true
});

// OSM preview (stable)
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// lock zoom checkbox
const lockZoomCheckbox = document.getElementById('lockZoom');
function applyZoomLock() {
  if (lockZoomCheckbox.checked) {
    map.scrollWheelZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.touchZoom.disable();
    map.keyboard.disable();
  } else {
    map.scrollWheelZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.touchZoom.enable();
    map.keyboard.enable();
  }
}
applyZoomLock();
lockZoomCheckbox.addEventListener('change', applyZoomLock);

// crop box elements
const crop = document.getElementById('cropBox');
const mapWrap = document.getElementById('map-wrap');
const mapContainer = map.getContainer();

let lastImageBlob = null;
let lastSize = 1024;

// initial crop size & center
function resetCrop() {
  const w = mapWrap.clientWidth * 0.35;
  const h = mapWrap.clientHeight * 0.35;
  crop.style.width = w + 'px';
  crop.style.height = h + 'px';
  crop.style.left = (mapWrap.clientWidth/2 - w/2) + 'px';
  crop.style.top = (mapWrap.clientHeight/2 - h/2) + 'px';
  updateCropMetersDisplay();
}
resetCrop();
window.addEventListener('resize', resetCrop);

// drag & resize (vanilla)
let dragging=false, resizing=false, resizeDir=null;
let start = { x:0, y:0, left:0, top:0, w:0, h:0 };

crop.addEventListener('mousedown', e=>{
  const handle = e.target.closest('.handle');
  if (handle) {
    resizing = true;
    resizeDir = handle.dataset.h;
  } else {
    dragging = true;
  }
  start.x = e.clientX; start.y = e.clientY;
  const r = crop.getBoundingClientRect(); start.left = r.left; start.top = r.top; start.w = r.width; start.h = r.height;
  document.body.style.userSelect = 'none';
});

window.addEventListener('mousemove', e=>{
  if (!dragging && !resizing) return;
  const dx = e.clientX - start.x, dy = e.clientY - start.y;
  const mw = mapWrap.getBoundingClientRect();

  if (dragging) {
    let nl = start.left + dx, nt = start.top + dy;
    nl = Math.max(mw.left, Math.min(nl, mw.right - start.w));
    nt = Math.max(mw.top, Math.min(nt, mw.bottom - start.h));
    crop.style.left = (nl - mw.left) + 'px';
    crop.style.top  = (nt - mw.top) + 'px';
    updateCropMetersDisplay();
  }

  if (resizing) {
    let newW = start.w, newH = start.h, newL = start.left, newT = start.top;
    if (resizeDir === 'h-tl') { newW = start.w - dx; newH = start.h - dy; newL = start.left + dx; newT = start.top + dy; }
    if (resizeDir === 'h-tr') { newW = start.w + dx; newH = start.h - dy; newT = start.top + dy; }
    if (resizeDir === 'h-bl') { newW = start.w - dx; newH = start.h + dy; newL = start.left + dx; }
    if (resizeDir === 'h-br') { newW = start.w + dx; newH = start.h + dy; }
    newW = Math.max(40, newW); newH = Math.max(40, newH);
    const relL = Math.max(mw.left, Math.min(newL, mw.right - newW));
    const relT = Math.max(mw.top, Math.min(newT, mw.bottom - newH));
    crop.style.width = newW + 'px';
    crop.style.height = newH + 'px';
    crop.style.left = (relL - mw.left) + 'px';
    crop.style.top  = (relT - mw.top) + 'px';
    updateCropMetersDisplay();
  }
});

window.addEventListener('mouseup', ()=>{
  dragging=false; resizing=false; resizeDir=null; document.body.style.userSelect='auto';
});

// meters/pixel calculation (WebMercator)
function metersPerPixel(lat, zoom) {
  // common formula: 156543.03392 * cos(lat) / 2^zoom
  return 156543.03392 * Math.cos(lat * Math.PI / 180) / Math.pow(2, zoom);
}

// compute current crop meters (square approx using width)
function getCurrentCropMeters() {
  const rect = crop.getBoundingClientRect();
  const mapRect = mapContainer.getBoundingClientRect();
  const centerX = (rect.left - mapRect.left) + rect.width/2;
  const centerY = (rect.top - mapRect.top) + rect.height/2;
  const latlng = map.containerPointToLatLng([centerX, centerY]);
  const mpp = metersPerPixel(latlng.lat, map.getZoom());
  const metersW = rect.width * mpp; const metersH = rect.height * mpp;
  return { metersW, metersH, lat: latlng.lat, lon: latlng.lng, mpp };
}

function updateCropMetersDisplay() {
  const info = getCurrentCropMeters();
  document.getElementById('result').innerText =
    `Crop center: ${info.lat.toFixed(6)}, ${info.lon.toFixed(6)}\n` +
    `Zoom: ${map.getZoom()} | meters/pixel: ${info.mpp.toFixed(3)}\n` +
    `Crop size (px): ${Math.round(crop.clientWidth)} × ${Math.round(crop.clientHeight)}\n` +
    `Crop real size: ${info.metersW.toFixed(2)} m × ${info.metersH.toFixed(2)} m`;
}

// set crop to exact meters (square) based on current map center & zoom
document.getElementById('setMetersBtn').addEventListener('click', ()=>{
  const meters = Number(document.getElementById('metersInput').value) || 720;
  // compute metersPerPixel at map center
  const center = map.getCenter();
  const mpp = metersPerPixel(center.lat, map.getZoom());
  const px = meters / mpp;
  // set crop size px (square), but constrain to map wrap
  const mw = mapWrap.getBoundingClientRect();
  const sizePx = Math.min(px, mw.width - 20, mw.height - 20);
  crop.style.width = sizePx + 'px';
  crop.style.height = sizePx + 'px';
  // center crop
  crop.style.left = (mw.width/2 - sizePx/2) + 'px';
  crop.style.top  = (mw.height/2 - sizePx/2) + 'px';
  updateCropMetersDisplay();
});

// also update display when map moves (so meters/pixel changes with latitude)
map.on('move', updateCropMetersDisplay);
map.on('zoomend', updateCropMetersDisplay);

// search Nominatim
document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;
  const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q);
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.length) return alert('Not found');
    map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], map.getZoom());
  } catch(e) {
    alert('Search error');
  }
});

// build Esri export URL (bbox minX,minY,maxX,maxY)
function buildEsriUrl(bbox, size) {
  const params = new URLSearchParams({
    bbox: bbox.join(','),
    bboxSR: 4326,
    size: `${size},${size}`,
    imageSR: 3857,
    format: 'jpgpng',
    f: 'image'
  });
  return 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/export?' + params.toString();
}

// helper: cropDOM -> bbox lon/lat
function getCropBbox() {
  const rect = crop.getBoundingClientRect();
  const mapRect = mapContainer.getBoundingClientRect();
  const x1 = rect.left - mapRect.left, y1 = rect.top - mapRect.top;
  const x2 = x1 + rect.width, y2 = y1 + rect.height;
  const p1 = map.containerPointToLatLng([x1, y1]);
  const p2 = map.containerPointToLatLng([x2, y2]);
  const minX = Math.min(p1.lng, p2.lng), maxX = Math.max(p1.lng,p2.lng);
  const minY = Math.min(p1.lat, p2.lat), maxY = Math.max(p1.lat,p2.lat);
  return [minX, minY, maxX, maxY];
}

// generate image
document.getElementById('btnGenerate').addEventListener('click', async ()=>{
  const size = parseInt(document.getElementById('sizeSel').value, 10);
  const bbox = getCropBbox();
  document.getElementById('result').innerText = 'Fetching image...';
  try {
    const url = buildEsriUrl(bbox, size);
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const blob = await res.blob();
    lastImageBlob = blob; lastSize = size;
    document.getElementById('result').innerText = `Image fetched: ${size}×${size}\nURL: ${url}\n\n` + document.getElementById('result').innerText;
    document.getElementById('btnExport').disabled = false;
  } catch (e) {
    document.getElementById('result').innerText = 'Error: ' + e;
  }
});

// export zip
document.getElementById('btnExport').addEventListener('click', async ()=>{
  if (!lastImageBlob) return alert('Generate first');
  document.getElementById('result').innerText = 'Building ZIP...';
  const bmp = await createImageBitmap(lastImageBlob);
  const thumb = document.createElement('canvas'); thumb.width = 240; thumb.height = 180;
  thumb.getContext('2d').drawImage(bmp,0,0,240,180);
  const thumbBlob = await new Promise(r=>thumb.toBlob(r,'image/jpeg'));

  const configTxt = `kuid               <kuid:xxxxxx:xxxx>\nusername           "Basemap HD"\nkind               "scenery"\nmesh-table\n{\n  default\n  {\n    mesh           "basemap.im"\n    auto-create    1\n  }\n}\n`;
  const textureTxt = `basemap.jpg\ncompression=jpeg\n`;
  const imTxt = `imfileversion 1.0\nmesh\n{\nvertex 4\n{ -0.5,0,-0.5 }\n{ 0.5,0,-0.5 }\n{ 0.5,0,0.5 }\n{ -0.5,0,0.5 }\npoly 2\n{ 0,1,2 }\n{ 0,2,3 }\n}\n`;

  const zip = new JSZip();
  zip.file('basemap.jpg', lastImageBlob);
  zip.file('thumbnail.jpg', thumbBlob);
  zip.file('basemap.texture.txt', textureTxt);
  zip.file('config.txt', configTxt);
  zip.file('basemap.im', imTxt);

  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, 'trainz_basemap.zip');
  document.getElementById('result').innerText = 'ZIP ready';
});

// initial display
updateCropMetersDisplay();
</script>
</body>
</html>

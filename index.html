<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basemap Generator PRO - Trainz Export</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f1f1f1; }
    .card { background:white; padding:20px; border-radius:14px; max-width:900px; margin:auto; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    input,button,select { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #aaa; box-sizing:border-box }
    button { font-weight:bold; cursor:pointer; }
    #map { height:420px; width:100%; margin-top:15px; border-radius:10px; }
    #result { margin-top:15px; background:#eef; padding:15px; border-radius:10px; white-space:pre-wrap; }
    .row { display:flex; gap:10px }
    .row > * { flex:1 }
    .small { width:48% }
  </style>
</head>
<body>
  <div class="card">
    <h2>Basemap Generator PRO (Realscale Trainz) — Export .zip Asset</h2>

    <label>Pilih Lokasi dari Map (klik pada map)</label>
    <div class="row">
      <input type="text" id="lat" placeholder="Latitude" readonly />
      <input type="text" id="lon" placeholder="Longitude" readonly />
    </div>

    <label>Zoom Level</label>
    <input type="number" id="zoom" value="18" min="0" max="22" />

    <label>Jumlah Tile (Grid) — 1 baseboard = 720m (grid x grid tiles)</label>
    <input type="number" id="grid" value="3" min="1" max="12" />

    <div class="row">
      <button id="btnGenerate">Generate Basemap</button>
      <button id="btnExport" disabled>Export as Trainz ZIP</button>
    </div>

    <label>Presets / Test cases (klik untuk coba)</label>
    <select id="preset">
      <option value="">-- pilih preset --</option>
      <option value="-7.150,110.140">Semarang, Central Java (sample)</option>
      <option value="-6.2088,106.8456">Jakarta (sample)</option>
      <option value="-6.9667,110.4167">Solo (sample)</option>
    </select>

    <div id="map"></div>
    <div id="result">Klik di map lalu Generate Basemap. Setelah berhasil, klik "Export as Trainz ZIP" untuk mengunduh asset siap import ke Content Manager.</div>
  </div>

<script>
// ----------------- Utilities -----------------
function latLonToTileXY(lat, lon, zoom) {
  var latRad = lat * Math.PI / 180;
  var n = Math.pow(2, zoom);
  var x = Math.floor((lon + 180) / 360 * n);
  var y = Math.floor((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n);
  return { x: x, y: y };
}
function tileXYToBounds(x, y, z) {
  var n = Math.pow(2, z);
  var lon1 = x / n * 360 - 180;
  var lat1 = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n))) * 180 / Math.PI;
  var lon2 = (x + 1) / n * 360 - 180;
  var lat2 = Math.atan(Math.sinh(Math.PI * (1 - 2 * (y + 1) / n))) * 180 / Math.PI;
  return [[lat2, lon1], [lat1, lon2]]; // southWest, northEast
}

// ----------------- Map and UI -----------------
var map;
var markers = [];
var tileLayer;
var lastTiles = null;

function initMap(lat, lon, zoom) {
  if (map) {
    map.off();
    map.remove();
  }
  map = L.map('map').setView([lat, lon], zoom || 13);
  tileLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
  tileLayer.addTo(map);

  map.on('click', function(e) {
    var latVal = e.latlng.lat.toFixed(6);
    var lonVal = e.latlng.lng.toFixed(6);
    document.getElementById('lat').value = latVal;
    document.getElementById('lon').value = lonVal;

    var m = L.marker([parseFloat(latVal), parseFloat(lonVal)], { draggable: true }).addTo(map);
    m.on('dragend', function(ev){
      var p = ev.target.getLatLng();
      document.getElementById('lat').value = p.lat.toFixed(6);
      document.getElementById('lon').value = p.lng.toFixed(6);
    });
    markers.push(m);
  });
}
initMap(-6.9667, 110.4167, 13);

function clearMarkers() {
  markers.forEach(function(m){ map.removeLayer(m); });
  markers = [];
}

// ----------------- Generate tiles and overlays -----------------
function generateBasemap() {
  var lat = parseFloat(document.getElementById('lat').value);
  var lon = parseFloat(document.getElementById('lon').value);
  var zoom = parseInt(document.getElementById('zoom').value, 10);
  var grid = parseInt(document.getElementById('grid').value, 10);
  if (isNaN(lat) || isNaN(lon)) {
    document.getElementById('result').innerText = 'Isi latitude dan longitude! Klik di map atau pilih preset.';
    return;
  }
  if (isNaN(zoom)) zoom = 18;
  if (isNaN(grid) || grid < 1) grid = 1;

  var center = latLonToTileXY(lat, lon, zoom);
  var half = Math.floor(grid / 2);
  var startX = center.x - half;
  var startY = center.y - half;

  var tiles = [];
  for (var dx = 0; dx < grid; dx++) {
    for (var dy = 0; dy < grid; dy++) {
      var tx = startX + dx;
      var ty = startY + dy;
      var url = 'https://tile.openstreetmap.org/' + zoom + '/' + tx + '/' + ty + '.png';
      tiles.push({ x: tx, y: ty, url: url });
    }
  }

  // draw rectangles
  if (window._tileRects) {
    window._tileRects.forEach(function(r){ map.removeLayer(r); });
  }
  window._tileRects = [];
  tiles.forEach(function(t){
    var b = tileXYToBounds(t.x, t.y, zoom);
    var rect = L.rectangle(b, { weight:1, fill:false }).addTo(map);
    window._tileRects.push(rect);
  });

  lastTiles = { tiles: tiles, zoom: zoom, grid: grid, center: center };

  var txt = 'Basemap Tiles Generated (OSM):

';
  for (var i = 0; i < tiles.length; i++) {
    txt += (i+1) + '. ' + tiles[i].url + '
';
  }
  txt += '
Total Tile: ' + tiles.length + '
';
  txt += 'Center tile coords: x=' + center.x + ', y=' + center.y + ' (zoom=' + zoom + ')
';
  txt += '
Klik "Export as Trainz ZIP" untuk membuat ZIP asset (config + texture + preview).
(Perhatian: tile fetch dapat dibatasi oleh server jika terlalu banyak permintaan)';
  document.getElementById('result').innerText = txt;

  // fit bounds
  var group = L.featureGroup((window._tileRects || []).concat(markers));
  if (group.getLayers().length > 0) map.fitBounds(group.getBounds(), { padding: [20,20] });

  document.getElementById('btnExport').disabled = false;
}

// ----------------- Export ZIP as Trainz-ready asset -----------------
function exportTrainzZip() {
  if (!lastTiles) {
    alert('Belum generate basemap. Klik Generate Basemap dahulu.');
    return;
  }
  var tiles = lastTiles.tiles;
  var grid = lastTiles.grid;
  var zoom = lastTiles.zoom;
  var assetName = 'basemap_asset';

  // attempt to stitch tiles into one image
  var tileSize = 256; // OSM tile size
  var cols = grid;
  var rows = grid;
  var canvas = document.createElement('canvas');
  canvas.width = cols * tileSize;
  canvas.height = rows * tileSize;
  var ctx = canvas.getContext('2d');

  // load each tile image with crossOrigin
  var loadPromises = tiles.map(function(t, index) {
    return new Promise(function(resolve) {
      var img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = function() { resolve({ img: img, index: index }); };
      img.onerror = function() { resolve({ img: null, index: index }); };
      img.src = t.url;
    });
  });

  Promise.all(loadPromises).then(function(results) {
    // draw images
    for (var i = 0; i < results.length; i++) {
      var r = results[i];
      var dx = i % cols;
      var dy = Math.floor(i / cols);
      if (r.img) {
        ctx.drawImage(r.img, dx * tileSize, dy * tileSize, tileSize, tileSize);
      } else {
        // draw placeholder
        ctx.fillStyle = '#444';
        ctx.fillRect(dx * tileSize, dy * tileSize, tileSize, tileSize);
        ctx.fillStyle = '#fff';
        ctx.fillText('no tile', dx * tileSize + 10, dy * tileSize + 20);
      }
    }

    canvas.toBlob(function(blob) {
      var zip = new JSZip();
      var root = zip.folder(assetName);

      // add preview and basemap image
      root.file('basemap.jpg', blob);
      root.file('preview.jpg', blob);

      // create a simple Trainz texture descriptor (basemap.texture.txt)
      var textureTxt = '';
      textureTxt += 'name = basemap_texture
';
      textureTxt += 'file = basemap.jpg
';
      textureTxt += 'width = ' + canvas.width + '
';
      textureTxt += 'height = ' + canvas.height + '
';
      textureTxt += 'format = JPEG
';
      root.file('basemap.texture.txt', textureTxt);

      // minimal config.txt (Trainz friendly generic)
      var cfg = '';
      cfg += 'name = ' + assetName + '
';
      cfg += 'author = Basemap Generator
';
      cfg += 'type = texture
';
      cfg += 'description = Basemap generated from OSM tiles
';
      cfg += 'date = ' + (new Date()).toISOString().split('T')[0] + '
';
      root.file('config.txt', cfg);

      // add readme/instructions
      var readme = '';
      readme += 'This ZIP contains a Trainz asset folder skeleton.
';
      readme += 'To import into Trainz Content Manager:
';
      readme += '1) Extract the ZIP to a folder.
';
      readme += '2) In Content Manager, click Import -> Local Content -> Add Content Folder, select the extracted folder.
';
      readme += '3) Commit the content to create a CDP.
';
      readme += '
Note: Some Trainz versions require specific config keys. If you need a specific version (TRS19 / Trainz+), request it and I will adapt the config template.
';
      root.file('readme.txt', readme);

      // generate zip
      zip.generateAsync({ type: 'blob' }).then(function(content) {
        saveAs(content, assetName + '.zip');
      });

    }, 'image/jpeg', 0.9);

  }).catch(function(err) {
    alert('Gagal memuat tile: ' + err);
  });
}

// wire UI
document.getElementById('btnGenerate').addEventListener('click', generateBasemap);
document.getElementById('btnExport').addEventListener('click', exportTrainzZip);

// presets
document.getElementById('preset').addEventListener('change', function(e){
  var v = e.target.value;
  if (!v) return;
  var parts = v.split(',');
  var plat = parseFloat(parts[0]);
  var plon = parseFloat(parts[1]);
  document.getElementById('lat').value = plat.toFixed(6);
  document.getElementById('lon').value = plon.toFixed(6);
  clearMarkers();
  var m = L.marker([plat, plon], { draggable: true }).addTo(map);
  markers.push(m);
  map.setView([plat, plon], 13);
});

</script>
</body>
</html>

<!-- Basemap Generator - Stable Version for GitHub Pages -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basemap Generator HD</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; font-family:Arial, sans-serif; background:#111; color:#fff }
    #map { width:100vw; height:75vh }
    #panel { padding:10px; background:#222; display:flex; gap:10px; align-items:center }
    button{ padding:8px 12px; border-radius:6px; border:0; background:#4caf50; color:#fff; cursor:pointer }
    button:disabled{ opacity:0.6; cursor:not-allowed }
    select,input{ padding:8px; border-radius:6px; border:1px solid #444; background:#111; color:#fff }
    pre#result{ max-height:12vh; overflow:auto; background:#0b0b0b; padding:8px; border-radius:6px }

    #searchBox {
      position:absolute;
      top:10px;
      left:10px;
      z-index:9999;
      display:flex;
      gap:6px;
    }
    #searchInput {
      width:240px;
      padding:7px;
      border-radius:6px;
      border:1px solid #444;
      background:#fff; color:#000;
    }
    #btnSearch {
      padding:7px 12px;
      border-radius:6px;
      border:0;
      background:#2196F3;
      color:#fff;
    }
  </style>
</head>
<body>

  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Search location...">
    <button id="btnSearch">Search</button>
  </div>

  <div id="map"></div>

  <div id="panel">
    <label>Ukuran Output:</label>
    <select id="sizeSel">
      <option value="1024">1024 × 1024</option>
      <option value="2048">2048 × 2048</option>
      <option value="4096">4096 × 4096</option>
    </select>
    <button id="btnGenerate">Generate Image</button>
    <button id="btnExport" disabled>Export Trainz ZIP</button>
    <span id="status"></span>
  </div>

  <pre id="result">Result: -</pre>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // Map initialization
    const map = L.map('map', { center:[-7.0,110.4], zoom:16 });

    // SAFE TILE FOR GITHUB PAGES (OSM)
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19,
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);

    let lastImageBlob = null;
    let lastSize = 1024;

    function setStatus(s){
      document.getElementById("status").innerText = s;
    }

    // Search
    document.getElementById("btnSearch").addEventListener("click", async () => {
      const q = document.getElementById("searchInput").value.trim();
      if (!q) return;

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.length === 0) return alert("Location not found!");

        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        map.setView([lat, lon], 17);

      } catch (err) {
        alert("Search error: " + err);
      }
    });

    // Build Esri export API URL
    function buildEsriExportURL(bbox, size){
      const params = new URLSearchParams({
        bbox,
        bboxSR:'4326',
        size: `${size},${size}`,
        imageSR:'3857',
        format:'jpgpng',
        f:'image'
      });
      return "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/export?" + params.toString();
    }

    // Generate image
    document.getElementById("btnGenerate").addEventListener("click", async () => {
      setStatus("Generating...");
      document.getElementById("btnExport").disabled = true;

      const size = parseInt(document.getElementById("sizeSel").value);
      lastSize = size;

      const b = map.getBounds();
      const bbox = `${b.getWest()},${b.getSouth()},${b.getEast()},${b.getNorth()}`;
      const url = buildEsriExportURL(bbox, size);

      try {
        const res = await fetch(url);
        lastImageBlob = await res.blob();

        document.getElementById("result").innerText = "Image fetched: " + size + "×" + size;
        setStatus("Ready to export");
        document.getElementById("btnExport").disabled = false;

      } catch (err) {
        setStatus("Error");
        document.getElementById("result").innerText = err;
      }
    });

    // Export ZIP for Trainz
    document.getElementById("btnExport").addEventListener("click", async () => {
      if (!lastImageBlob) return alert("Generate image dulu!");

      setStatus("Building ZIP...");

      // thumbnail
      const bmp = await createImageBitmap(lastImageBlob);
      const c = document.createElement("canvas");
      c.width = 240; c.height = 180;
      c.getContext("2d").drawImage(bmp,0,0,240,180);
      const thumbBlob = await new Promise(r => c.toBlob(r,"image/jpeg"));

      // config.txt
      const configTxt =
`kuid               <kuid:xxxxxx:xxxx>
username           "Basemap HD"
description        "Generated basemap"
trainz-build       2.9
kind               "scenery"
category-class     "BR"
category-era       "2010s"
category-region    "ID"
author             "Farhan Abdul Rahman"

mesh-table
{
  default
  {
    mesh           "basemap.im"
    auto-create    1
  }
}
light              1

thumbnails
{
  0
  {
    image          "thumbnail.jpg"
    width          240
    height         180
  }
}`;

      const textureTxt = "basemap.jpg\ncompression=jpeg\n";

      const imTxt =
`imfileversion 1.0
mesh
{
  vertex 4
  { -0.5, 0, -0.5 }
  {  0.5, 0, -0.5 }
  {  0.5, 0,  0.5 }
  { -0.5, 0,  0.5 }
  poly 2
  { 0,1,2 }
  { 0,2,3 }
}`;

      const zip = new JSZip();
      zip.file("basemap.jpg", lastImageBlob);
      zip.file("thumbnail.jpg", thumbBlob);
      zip.file("basemap.texture.txt", textureTxt);
      zip.file("basemap.im", imTxt);
      zip.file("config.txt", configTxt);

      const blob = await zip.generateAsync({type:"blob"});
      saveAs(blob, "trainz_basemap.zip");

      setStatus("ZIP Ready");
    });
  </script>
</body>
</html>

<!-- Basemap Generator â€” Trainz-ready -->
<script>
document.getElementById('btnExport').addEventListener('click', async ()=>{
    if(!lastImageBlob) return alert('Generate first');
    document.getElementById('result').innerText = 'Building ZIP...';

    // thumbnail
    const bmp = await createImageBitmap(lastImageBlob);
    const thumb = document.createElement('canvas'); thumb.width=240; thumb.height=180;
    thumb.getContext('2d').drawImage(bmp,0,0,240,180);
    const thumbBlob = await new Promise(r=>thumb.toBlob(r,'image/jpeg'));

    // --- config.txt ---
    const configTxt = `
kuid               <kuid:354892:0001>
description        "Basemap HD"
username           "Basemap Asset"
trainz-build       2.9
kind               "scenery"
category-class     "BR"
category-era       "2010s"
category-region    "US"
author             "Farhan Abdul Rahman"
organisation       "NXTIndustries"
contact-email      "abdularrr478@gmail.com"
contact-website    ""
license            ""

mesh-table
{
  default
  {
    mesh           "basemap.im"
    auto-create    1
  }
}
light              1

thumbnails
{
  0
  {
    image          "thumbnail.jpg"
    width          240
    height         180
  }
}

kuid-table
{
}
`;

    // --- basemap.texture.txt ---
    const textureTxt = `Primary=basemap.jpg
Tile=st
`;

    // --- basemap.im with UV mapping ---
    const imTxt = `imfileversion 1.0
mesh
{
vertex 4
{ -0.5,0,-0.5 }
{ 0.5,0,-0.5 }
{ 0.5,0,0.5 }
{ -0.5,0,0.5 }
uv 4
{ 0,0 }
{ 1,0 }
{ 1,1 }
{ 0,1 }
poly 2
{ 0,1,2 }
{ 0,2,3 }
}
`;

    const zip = new JSZip();
    zip.file('basemap.jpg', lastImageBlob);
    zip.file('thumbnail.jpg', thumbBlob);
    zip.file('basemap.texture.txt', textureTxt);
    zip.file('config.txt', configTxt);
    zip.file('basemap.im', imTxt);

    const blob = await zip.generateAsync({type:'blob'});
    saveAs(blob, 'trainz_basemap.zip');
    document.getElementById('result').innerText = 'ZIP ready for Trainz';
});
</script>
